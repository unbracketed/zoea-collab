# Docker Compose for Zoea Collab system core (zoea-core)
# Services: Django backend (Ninja API), Django-Q2 worker, PostgreSQL, ChromaDB store

name: zoea-core

x-zoea-core-env-file: &zoea-core-env-file
  - ../../.env

x-zoea-core-env: &zoea-core-env
  # Use a dedicated env var so local host DATABASE_URL doesn't leak into Docker.
  DATABASE_URL: ${ZOEA_CORE_DATABASE_URL:-postgresql://zoea:zoea@db:5432/zoea}
  CHROMADB_PERSIST_DIRECTORY: /app/chromadb
  ZOEA_SKILLS_DIRS: /app/skills
  ZOEA_INSTANCE: ${ZOEA_INSTANCE:-core}

services:
  backend:
    container_name: zoea-core-backend
    build:
      context: .
      dockerfile: Dockerfile
    env_file: *zoea-core-env-file
    ports:
      - "${ZOEA_CORE_BACKEND_PORT:-8000}:8000"
    volumes:
      - ./:/app
      - ../skills:/app/skills:ro
      - core-venv:/app/.venv
      - core-data:/app/data
      - core-media:/app/media
      - core-chromadb:/app/chromadb
    environment: *zoea-core-env
    # Set ZOEA_CORE_BACKEND_COMMAND to switch to gunicorn or other server.
    # Example: ZOEA_CORE_BACKEND_COMMAND="uv run gunicorn zoea.wsgi:application --bind 0.0.0.0:8000 --workers 2"
    command: ${ZOEA_CORE_BACKEND_COMMAND:-uv run python manage.py runserver 0.0.0.0:8000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      db:
        condition: service_healthy

  worker:
    container_name: zoea-core-worker
    build:
      context: .
      dockerfile: Dockerfile
    env_file: *zoea-core-env-file
    volumes:
      - ./:/app
      - ../skills:/app/skills:ro
      - core-venv:/app/.venv
      - core-data:/app/data
      - core-media:/app/media
      - core-chromadb:/app/chromadb
    environment: *zoea-core-env
    command: uv run python manage.py qcluster
    depends_on:
      backend:
        condition: service_healthy

  db:
    container_name: zoea-core-db
    image: postgres:16-alpine
    env_file: *zoea-core-env-file
    ports:
      - "${ZOEA_CORE_POSTGRES_PORT:-5432}:5432"
    volumes:
      - core-postgres:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zoea}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zoea}
      POSTGRES_DB: ${POSTGRES_DB:-zoea}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zoea} -d ${POSTGRES_DB:-zoea}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  core-venv:
    name: zoea-core-venv
  core-data:
    name: zoea-core-data
  core-media:
    name: zoea-core-media
  core-chromadb:
    name: zoea-core-chromadb
  core-postgres:
    name: zoea-core-postgres
